var bingaerial = new L.BingLayer("AsyRHq25Hv8jQbrAIVSeZEifWbP6s1nq1RQfDeUf0ycdHogebEL7W2dxgFmPJc9h", {
  type: 'Aerial',
  attribution: ''
});

var bingroad = new L.BingLayer("AsyRHq25Hv8jQbrAIVSeZEifWbP6s1nq1RQfDeUf0ycdHogebEL7W2dxgFmPJc9h", {
  type: 'Road',
  attribution: ''
});

var binghybrid = new L.BingLayer("AsyRHq25Hv8jQbrAIVSeZEifWbP6s1nq1RQfDeUf0ycdHogebEL7W2dxgFmPJc9h", {
  type: 'AerialWithLabels',
  attribution: ''
});

var openstreetUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  openstreetAttribution = '',
  openstreet = new L.TileLayer(openstreetUrl, {
  maxZoom : 18,
  attribution : openstreetAttribution
});

var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', cloudmadeAttribution = '', cloudmade = new L.TileLayer(cloudmadeUrl, {
  maxZoom : 18,
  attribution : cloudmadeAttribution
});

function get_param(param) {
  var search = window.location.search.substring(1);
  var compareKeyValuePair = function(pair) {
    var key_value = pair.split('=');
    var decodedKey = decodeURIComponent(key_value[0]);
    var decodedValue = decodeURIComponent(key_value[1]);
    if(decodedKey == param) return decodedValue;
    return null;
  };

  var comparisonResult = null;

  if(search.indexOf('&') > -1) {
    var params = search.split('&');
    for(var i = 0; i < params.length; i++) {
      comparisonResult = compareKeyValuePair(params[i]);
      if(comparisonResult !== null) {
        break;
      }
    }
  } else {
    comparisonResult = compareKeyValuePair(search);
  }
  return comparisonResult;
}

var map = new L.Map('map-container', {
  center : new L.LatLng(-10.0, -58.0),
  zoom : 6,
  layers : [bingroad],
  zoomControl : true
});

function processTMS(data) {
  function onEachFeature(feature, layer) {

    var popupContent = "<p>I started out as a GeoJSON " +
      feature.geometry.type + ", but now I'm a Leaflet vector!</p>";

    if (feature.properties && feature.properties.popupContent) {
      popupContent += feature.properties.popupContent;
    }

    layer.bindPopup(popupContent);

    layer.on("mouseover", function(e){
      var tmsUrl = feature.properties.url_tiles + "{z}/{x}/{y}.png";

      layer.setStyle({fillColor: 'transparent', stroke: false});

      rapidEye[rapidEye.count].tileId = layer._leaflet_id;
      rapidEye[rapidEye.count].setUrl(tmsUrl);
      rapidEye[rapidEye.count].redraw();
      rapidEye.count++;

      if(rapidEye.count > 4) {
        rapidEye.count = 1;
      }
    });
    layer.on("mouseout", function(e){
      layer.setStyle({stroke: true});
    });

  }

  var rapidEye = {};
  rapidEye.count = 1;
  for(i=1; i<=4; i++){
    rapidEye[i] = new L.TileLayer("", {
      minZoom: 3,
      maxZoom: 17,
      tms: true
    });
    rapidEye[i].addTo(map);
  }

  var geojson = L.geoJson(data,{
    style: {
      fillColor: 'transparent',
      weight: 2
    },
    onEachFeature: onEachFeature
  });

  geojson.addTo(map);
}

$.getJSON("geojson/rapideye/pampas.json", function(data){
  processTMS(data);
});


var baseMaps = {
  "Bing Aerial" : bingaerial,
  "Bing Road" : bingroad,
  "Bing Hybrid" : binghybrid,
  "OSM" : openstreet
};

var overlayMaps = {
};

// add layer menu
L.control.layers(baseMaps, overlayMaps).addTo(map);

// add custom attribution
map.attributionControl.setPrefix('Hexgis Hash5')

// add scale
L.control.scale().addTo(map);

// display stations
var alertaLayer = new lvector.PRWSF({
  url: "../painel/rest/",
  geotable: "alerta",
  fields: "objectid",
  srid: 4618,
  geomFieldName: 'shape',
  showAll: true,
  popupTemplate: '<div class="iw-content"><center><h3>{objectid}</h3></center></div>',
  singlePopup: true,
  where: "ano = '2013'",
  symbology: {
    type: "single",
    vectorOptions: {
      fillColor: "#ff0000",
      fillOpacity: 0.6,
      weight: 1.2,
      color: "#ff0000",
      opacity: 0.8,
    }
  }
});

alertaLayer.setMap(map);
